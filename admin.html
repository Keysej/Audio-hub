<!-- admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - SoundDrop</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .login-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      margin-bottom: 30px;
    }
    
    .login-form {
      margin-top: 20px;
    }
    
    .login-form input {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      margin: 10px;
      width: 200px;
    }
    
    .login-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin: 10px;
      transition: all 0.3s ease;
    }
    
    .login-btn:hover {
      background: #ee5a24;
      transform: translateY(-2px);
    }
    
    .dashboard-section {
      display: none;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 25px;
      border-radius: 15px;
      text-align: center;
    }
    
    .stat-number {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .data-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .section-title {
      color: #2c3e50;
      font-size: 1.5em;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    
    .drop-item {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
    }
    
    .drop-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .drop-title {
      color: #2c3e50;
      font-weight: 600;
      margin: 0;
    }
    
    .drop-meta {
      color: #7f8c8d;
      font-size: 0.9em;
      margin: 5px 0;
    }
    
    .play-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 10px;
    }
    
    .play-btn:hover {
      background: #ee5a24;
    }
    
    .comments-section {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .comment {
      background: white;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border-left: 3px solid #667eea;
    }
    
    .export-buttons {
      text-align: center;
      margin: 20px 0;
    }
    
    .export-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin: 0 10px;
      transition: all 0.3s ease;
    }
    
    .export-btn:hover {
      background: #218838;
      transform: translateY(-2px);
    }
    
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- Login Section -->
    <div id="login-section" class="login-section">
        <h1>‚öôÔ∏è SoundDrop Admin</h1>
      <p>Access comprehensive research data and analytics</p>
      <div class="login-form">
        <input type="password" id="admin-password" placeholder="Enter admin password" />
        <br>
        <button class="login-btn" onclick="loginAdmin()">Access Dashboard</button>
      </div>
      <div id="login-error" class="error-message" style="display: none;"></div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="dashboard-section">
      <h1>üìä Research Dashboard</h1>
      
      <!-- Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="total-drops">-</div>
          <div>Total Drops</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="active-drops">-</div>
          <div>Active</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="archived-drops">-</div>
          <div>Archived</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="total-comments">-</div>
          <div>Comments</div>
        </div>
      </div>

      <!-- Export Buttons -->
      <div class="export-buttons">
        <button class="export-btn" onclick="exportData('json')">üìÑ Export JSON</button>
        <button class="export-btn" onclick="exportData('csv')">üìä Export CSV</button>
        <button class="export-btn" onclick="refreshData()">üîÑ Refresh Data</button>
        <button class="export-btn" onclick="forceArchive()" style="background: #ff6b6b;">üóÑÔ∏è Test Archive</button>
      </div>

      <!-- Data Display -->
      <div id="data-display">
        <div class="loading">Loading research data...</div>
      </div>
    </div>
  </div>

  <script>
    let adminAuthenticated = false;
    let currentAudio = null;
    let adminPassword = 'research2024';

    function loginAdmin() {
      const password = document.getElementById('admin-password').value;
      const errorDiv = document.getElementById('login-error');
      
      if (password === adminPassword) {
        adminAuthenticated = true;
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'block';
        loadDashboardData();
        errorDiv.style.display = 'none';
      } else {
        errorDiv.textContent = 'Invalid password. Please try again.';
        errorDiv.style.display = 'block';
      }
    }

    async function loadDashboardData() {
      try {
        let activeData = [];
        
        // First try to load from API
        try {
          const activeResponse = await fetch('/api/sound-drops');
          if (activeResponse.ok) {
            activeData = await activeResponse.json();
            console.log('Loaded data from API:', activeData.length, 'drops');
          }
        } catch (e) {
          console.log('API not available, will use localStorage');
        }
        
        // If no API data, fall back to localStorage (but with 7-day window for research)
        if (activeData.length === 0) {
          try {
            const stored = localStorage.getItem('soundDropsBackup');
            if (stored) {
              const localData = JSON.parse(stored);
              // For admin dashboard: show data from last 7 days (research needs)
              const now = Date.now();
              const sevenDays = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
              activeData = localData.filter(drop => (now - drop.timestamp) < sevenDays);
              console.log('Loaded data from localStorage (7-day window):', activeData.length, 'drops');
            }
          } catch (e) {
            console.error('Error reading localStorage:', e);
          }
        }
        
        // Try to load archived data from research endpoint
        let archivedData = [];
        try {
          const exportResponse = await fetch('/api/research/export?format=json&key=research2024');
          if (exportResponse.ok) {
            const exportData = await exportResponse.json();
            if (exportData.data) {
              // Filter for archived data only
              archivedData = exportData.data.filter(drop => drop.data_source === 'archived');
              console.log('Loaded archived data from research API:', archivedData.length, 'drops');
            }
          }
        } catch (e) {
          console.log('Research archive not available:', e);
        }

        // Update statistics
        updateStatistics(activeData, archivedData);
        
        // Display data
        displayData(activeData, archivedData);
        
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        document.getElementById('data-display').innerHTML = 
          `<div class="error-message">Error loading data: ${error.message}</div>`;
      }
    }

    function updateStatistics(activeData, archivedData) {
      const totalComments = activeData.reduce((sum, drop) => sum + (drop.discussions?.length || 0), 0);
      
      document.getElementById('total-drops').textContent = activeData.length + archivedData.length;
      document.getElementById('active-drops').textContent = activeData.length;
      document.getElementById('archived-drops').textContent = archivedData.length;
      document.getElementById('total-comments').textContent = totalComments;
    }

    function displayData(activeData, archivedData) {
      const dataDisplay = document.getElementById('data-display');
      let html = '';

      // Data source indicator
      const dataSource = activeData.length > 0 ? 
        (activeData[0].id ? 'localStorage' : 'API') : 'none';
      
      html += `
        <div style="background: #e8f4fd; padding: 10px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9em;">
          üìä Data Source: ${dataSource === 'localStorage' ? 'üíæ Local Storage (Browser)' : 
                            dataSource === 'API' ? 'üåê API Server' : '‚ùå No Data'}
          <br><small>üóìÔ∏è Showing data from the last 7 days (research view)</small>
          ${dataSource === 'localStorage' ? '<br><small>üí° Data is from your browser storage. API sync may not be working.</small>' : ''}
        </div>
      `;

      // Active Data Section
      if (activeData.length > 0) {
        html += `
          <div class="data-section">
            <h2 class="section-title">üìä Research Data - Last 7 Days (${activeData.length})</h2>
            ${activeData.map(drop => createDropHTML(drop, 'active')).join('')}
          </div>
        `;
      }

      // Archived Data Section (placeholder for now)
      if (archivedData.length > 0) {
        html += `
          <div class="data-section">
            <h2 class="section-title">üì¶ Archived Drops (${archivedData.length})</h2>
            ${archivedData.map(drop => createDropHTML(drop, 'archived')).join('')}
          </div>
        `;
      }

      if (activeData.length === 0 && archivedData.length === 0) {
        html = `
          <div class="data-section">
            <h2 class="section-title">üì≠ No Data Available</h2>
            <p>No research data has been collected yet. Data will appear here as users interact with SoundDrop.</p>
          </div>
        `;
      }

      dataDisplay.innerHTML = html;
    }

    function createDropHTML(drop, type) {
      const timestamp = new Date(drop.timestamp).toLocaleString();
      const commentsHtml = drop.discussions && drop.discussions.length > 0 ? `
        <div class="comments-section">
          <strong>üí¨ Comments (${drop.discussions.length}):</strong>
          ${drop.discussions.map(comment => `
            <div class="comment">
              <strong>${comment.author || 'User'}:</strong> ${comment.text}
              <br><small>${new Date(comment.timestamp).toLocaleString()}</small>
            </div>
          `).join('')}
        </div>
      ` : '';

      return `
        <div class="drop-item">
          <div class="drop-header">
            <h3 class="drop-title">${drop.theme || 'No Theme'}</h3>
            ${drop.audioData ? `<button class="play-btn" onclick="playAudio('${drop.audioData}', this)">‚ñ∂Ô∏è Play</button>` : ''}
          </div>
          <div class="drop-meta">
            üìÖ ${timestamp} | üéµ ${drop.type || 'Unknown'} | üìÑ ${drop.filename || 'No filename'}
            ${type === 'archived' ? ' | üì¶ Archived' : ''}
          </div>
          ${drop.context ? `<div class="drop-meta">üí≠ ${drop.context}</div>` : ''}
          ${commentsHtml}
        </div>
      `;
    }

    function playAudio(audioData, button) {
      // Stop current audio if playing
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
        // Reset all buttons
        document.querySelectorAll('.play-btn').forEach(btn => {
          btn.textContent = '‚ñ∂Ô∏è Play';
        });
      }
      
      // Play new audio
      if (button.textContent === '‚ñ∂Ô∏è Play') {
        currentAudio = new Audio(audioData);
        currentAudio.play();
        button.textContent = '‚è∏Ô∏è Pause';
        
        currentAudio.onended = () => {
          button.textContent = '‚ñ∂Ô∏è Play';
          currentAudio = null;
        };
      }
    }

    async function exportData(format) {
      if (!adminAuthenticated) {
        alert('Please log in first');
        return;
      }
      
      try {
        // Get the same data that's displayed in the dashboard (7-day window)
        let exportData = [];
        
        // First try API
        try {
          const apiResponse = await fetch('/api/sound-drops');
          if (apiResponse.ok) {
            exportData = await apiResponse.json();
          }
        } catch (e) {
          console.log('API not available for export, using localStorage');
        }
        
        // If no API data, use localStorage with 7-day window (same as dashboard)
        if (exportData.length === 0) {
          try {
            const stored = localStorage.getItem('soundDropsBackup');
            if (stored) {
              const localData = JSON.parse(stored);
              const now = Date.now();
              const sevenDays = 7 * 24 * 60 * 60 * 1000;
              exportData = localData.filter(drop => (now - drop.timestamp) < sevenDays);
            }
          } catch (e) {
            console.error('Error reading localStorage for export:', e);
          }
        }
        
        if (exportData.length === 0) {
          alert('No data available to export');
          return;
        }
        
        const timestamp = new Date().toISOString().split('T')[0];
        
        if (format === 'json') {
          const jsonExport = {
            export_info: {
              timestamp: new Date().toISOString(),
              total_drops: exportData.length,
              date_range: '7 days',
              total_comments: exportData.reduce((sum, drop) => sum + (drop.discussions?.length || 0), 0)
            },
            data: exportData
          };
          downloadJSON(jsonExport, `sounddrop_research_${timestamp}.json`);
        } else if (format === 'csv') {
          downloadCSV(exportData, `sounddrop_research_${timestamp}.csv`);
        }
        
      } catch (error) {
        console.error('Export error:', error);
        alert('Export failed: ' + error.message);
      }
    }

    function downloadJSON(data, filename) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function downloadCSV(data, filename) {
      // Flatten data for CSV
      const rows = [];
      const headers = ['id', 'timestamp', 'theme', 'type', 'filename', 'context', 'comments_count'];
      rows.push(headers);

      data.forEach(drop => {
        const row = [
          drop.id || '',
          new Date(drop.timestamp).toISOString(),
          drop.theme || '',
          drop.type || '',
          drop.filename || '',
          drop.context || '',
          drop.discussions?.length || 0
        ];
        rows.push(row);

        // Add comment rows
        if (drop.discussions && drop.discussions.length > 0) {
          drop.discussions.forEach((comment, index) => {
            const commentRow = [
              drop.id || '',
              new Date(drop.timestamp).toISOString(),
              drop.theme || '',
              drop.type || '',
              drop.filename || '',
              `COMMENT_${index + 1}: ${comment.text}`,
              drop.discussions.length
            ];
            rows.push(commentRow);
          });
        }
      });

      const csvContent = rows.map(row => 
        row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
      ).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function refreshData() {
      document.getElementById('data-display').innerHTML = '<div class="loading">Refreshing data...</div>';
      loadDashboardData();
    }

    async function forceArchive() {
      if (!adminAuthenticated) {
        alert('Please log in first');
        return;
      }
      
      try {
        const response = await fetch('/api/research/force-archive?key=research2024');
        const result = await response.json();
        
        if (response.ok) {
          alert(`Archive Test Result:\n${result.message}\n\nFound: ${result.total_found || 0} drops\nArchived: ${result.archived || 0} drops`);
          // Refresh the dashboard to show any newly archived data
          refreshData();
        } else {
          alert(`Archive test failed: ${result.error || result.message}`);
        }
      } catch (error) {
        alert(`Archive test error: ${error.message}`);
      }
    }

    // Handle Enter key in password field
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('admin-password').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          loginAdmin();
        }
      });
    });
  </script>
</body>
</html>
